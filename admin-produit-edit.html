<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√âdition Produit - Imprixo Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap');
        * { font-family: 'Roboto', sans-serif; }
        .btn-primary { background: linear-gradient(135deg, #e63946 0%, #d62839 100%); }
        .tab { cursor: pointer; }
        .tab.active { background: #e63946; color: white; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-gradient-to-r from-gray-900 to-gray-800 text-white py-4 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 flex justify-between items-center">
            <h1 class="text-3xl font-black">Imprixo<span class="text-red-500">Admin</span></h1>
            <a href="/admin-produits.html" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg font-bold">‚Üê Retour</a>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <h2 class="text-3xl font-black text-gray-900 mb-8" id="page-title">‚úèÔ∏è √âdition Produit</h2>

        <!-- Tabs -->
        <div class="bg-white rounded-xl shadow-lg mb-6">
            <div class="flex border-b">
                <div class="tab active px-6 py-4 font-bold" onclick="switchTab('general')">üìù G√©n√©ral</div>
                <div class="tab px-6 py-4 font-bold" onclick="switchTab('prices')">üí∞ Prix</div>
                <div class="tab px-6 py-4 font-bold" onclick="switchTab('config')">‚öôÔ∏è Configurateur</div>
                <div class="tab px-6 py-4 font-bold" onclick="switchTab('promo')">üî• Promotion</div>
            </div>
        </div>

        <form id="product-form">
            <!-- TAB: G√©n√©ral -->
            <div id="tab-general" class="tab-content">
                <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
                    <h3 class="text-2xl font-black mb-6">üìù Informations g√©n√©rales</h3>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">ID Produit *</label>
                            <input type="text" id="id" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-red-600 focus:outline-none">
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Cat√©gorie *</label>
                            <select id="categorie" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-red-600 focus:outline-none">
                                <option value="PVC">PVC</option>
                                <option value="Aluminium">Aluminium</option>
                                <option value="Bache">B√¢che</option>
                                <option value="Textile">Textile</option>
                            </select>
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-bold text-gray-700 mb-2">Nom du produit *</label>
                            <input type="text" id="nom" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-red-600 focus:outline-none">
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-bold text-gray-700 mb-2">Sous-titre</label>
                            <input type="text" id="soustitre" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-red-600 focus:outline-none">
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-bold text-gray-700 mb-2">Description courte</label>
                            <textarea id="desc_courte" rows="2" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-red-600 focus:outline-none"></textarea>
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-bold text-gray-700 mb-2">Description longue</label>
                            <textarea id="desc_longue" rows="4" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-red-600 focus:outline-none"></textarea>
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-bold text-gray-700 mb-2">URL Image</label>
                            <input type="url" id="image_url" placeholder="https://..." class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-red-600 focus:outline-none">
                            <div id="image-preview" class="mt-4 hidden">
                                <img src="" alt="Preview" class="w-48 h-48 object-cover rounded-lg">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">D√©lai livraison (jours)</label>
                            <input type="number" id="delai" min="1" value="3" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-red-600 focus:outline-none">
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Certification</label>
                            <input type="text" id="certification" placeholder="Ex: M1 - Ignifug√©" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-red-600 focus:outline-none">
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: Prix -->
            <div id="tab-prices" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
                    <h3 class="text-2xl font-black mb-6">üí∞ Grille tarifaire</h3>
                    <p class="text-gray-600 mb-6">Prix au m¬≤ selon la surface command√©e</p>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">0-10 m¬≤ *</label>
                            <div class="flex">
                                <input type="number" id="prix_0_10" step="0.01" required class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-l-lg focus:border-red-600 focus:outline-none">
                                <span class="bg-gray-200 px-4 py-3 border-2 border-l-0 border-gray-300 rounded-r-lg font-bold">‚Ç¨/m¬≤</span>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">11-50 m¬≤ *</label>
                            <div class="flex">
                                <input type="number" id="prix_11_50" step="0.01" required class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-l-lg focus:border-red-600 focus:outline-none">
                                <span class="bg-gray-200 px-4 py-3 border-2 border-l-0 border-gray-300 rounded-r-lg font-bold">‚Ç¨/m¬≤</span>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">51-100 m¬≤ *</label>
                            <div class="flex">
                                <input type="number" id="prix_51_100" step="0.01" required class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-l-lg focus:border-red-600 focus:outline-none">
                                <span class="bg-gray-200 px-4 py-3 border-2 border-l-0 border-gray-300 rounded-r-lg font-bold">‚Ç¨/m¬≤</span>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">101-300 m¬≤ *</label>
                            <div class="flex">
                                <input type="number" id="prix_101_300" step="0.01" required class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-l-lg focus:border-red-600 focus:outline-none">
                                <span class="bg-gray-200 px-4 py-3 border-2 border-l-0 border-gray-300 rounded-r-lg font-bold">‚Ç¨/m¬≤</span>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">300+ m¬≤ *</label>
                            <div class="flex">
                                <input type="number" id="prix_300_plus" step="0.01" required class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-l-lg focus:border-red-600 focus:outline-none">
                                <span class="bg-gray-200 px-4 py-3 border-2 border-l-0 border-gray-300 rounded-r-lg font-bold">‚Ç¨/m¬≤</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: Configurateur -->
            <div id="tab-config" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
                    <h3 class="text-2xl font-black mb-6">‚öôÔ∏è Options du configurateur</h3>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-3">Formats pr√©d√©finis</label>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600 mb-3">8 formats standards (A0, A1, Roll-up, Panneaux, Grands formats, Personnalis√©)</p>
                            <p class="text-xs text-gray-500">Les formats sont identiques pour tous les produits actuellement.</p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-3">Finitions disponibles</label>
                        <div id="finitions-list" class="space-y-3"></div>
                        <button type="button" onclick="addFinition()" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold">
                            + Ajouter une finition
                        </button>
                    </div>
                </div>
            </div>

            <!-- TAB: Promotion -->
            <div id="tab-promo" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
                    <h3 class="text-2xl font-black mb-6">üî• Promotion</h3>
                    
                    <div class="mb-6">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="promo_active" class="w-5 h-5" onchange="togglePromo()">
                            <span class="font-bold text-lg">Activer une promotion sur ce produit</span>
                        </label>
                    </div>

                    <div id="promo-fields" class="hidden space-y-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Prix promotionnel (‚Ç¨/m¬≤)</label>
                            <input type="number" id="promo_prix" step="0.01" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-red-600 focus:outline-none">
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Titre de la promotion</label>
                            <input type="text" id="promo_titre" placeholder="Ex: -20% pour No√´l !" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-red-600 focus:outline-none">
                        </div>

                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Date de d√©but</label>
                                <input type="datetime-local" id="promo_start" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-red-600 focus:outline-none">
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Date de fin</label>
                                <input type="datetime-local" id="promo_end" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-red-600 focus:outline-none">
                            </div>
                        </div>

                        <div>
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="promo_countdown" class="w-5 h-5">
                                <span class="font-bold">Afficher un compte √† rebours</span>
                            </label>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Badge promotion</label>
                            <select id="promo_badge" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-red-600 focus:outline-none">
                                <option value="PROMO">PROMO</option>
                                <option value="SOLDES">SOLDES</option>
                                <option value="-20%">-20%</option>
                                <option value="BLACK FRIDAY">BLACK FRIDAY</option>
                                <option value="NOUVEAU">NOUVEAU</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Boutons d'action -->
            <div class="flex gap-4">
                <button type="submit" class="btn-primary text-white px-8 py-4 rounded-lg font-black text-lg">
                    üíæ ENREGISTRER
                </button>
                <a href="/admin-produits.html" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-8 py-4 rounded-lg font-black text-lg">
                    ANNULER
                </a>
                <button type="button" onclick="deleteProduct()" class="ml-auto bg-red-600 hover:bg-red-700 text-white px-8 py-4 rounded-lg font-black text-lg">
                    üóëÔ∏è SUPPRIMER
                </button>
            </div>
        </form>
    </div>

    <script src="/init-products.js"></script>
    <script>
    if (localStorage.getItem('admin_logged') !== 'true') {
        window.location.href = '/admin-login.html';
    }

    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');
    const isNew = urlParams.get('action') === 'new';
    let currentProduct = null;

    // Switch tab
    function switchTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        
        event.target.classList.add('active');
        document.getElementById('tab-' + tab).classList.remove('hidden');
    }

    // Toggle promotion
    function togglePromo() {
        const active = document.getElementById('promo_active').checked;
        document.getElementById('promo-fields').classList.toggle('hidden', !active);
    }

    // Charger le produit
    function loadProduct() {
        initProductsIfNeeded();
        
        if (isNew) {
            document.getElementById('page-title').textContent = '‚ûï Nouveau Produit';
            loadDefaultFinitions();
            return;
        }

        const products = JSON.parse(localStorage.getItem('products') || '[]');
        currentProduct = products.find(p => p.id === productId);

        if (!currentProduct) {
            alert('Produit introuvable');
            window.location.href = '/admin-produits.html';
            return;
        }

        // Remplir le formulaire
        document.getElementById('id').value = currentProduct.id;
        document.getElementById('categorie').value = currentProduct.categorie;
        document.getElementById('nom').value = currentProduct.nom;
        document.getElementById('soustitre').value = currentProduct.soustitre || '';
        document.getElementById('desc_courte').value = currentProduct.desc_courte || '';
        document.getElementById('desc_longue').value = currentProduct.desc_longue || '';
        document.getElementById('image_url').value = currentProduct.image_url || '';
        document.getElementById('delai').value = currentProduct.delai || 3;
        document.getElementById('certification').value = currentProduct.certification || '';
        
        document.getElementById('prix_0_10').value = currentProduct.prix_0_10;
        document.getElementById('prix_11_50').value = currentProduct.prix_11_50;
        document.getElementById('prix_51_100').value = currentProduct.prix_51_100;
        document.getElementById('prix_101_300').value = currentProduct.prix_101_300;
        document.getElementById('prix_300_plus').value = currentProduct.prix_300_plus;

        // Finitions
        loadFinitions(currentProduct.finitions || []);

        // Promo
        if (currentProduct.promo) {
            document.getElementById('promo_active').checked = true;
            document.getElementById('promo-fields').classList.remove('hidden');
            document.getElementById('promo_prix').value = currentProduct.promo.prix_promo || '';
            document.getElementById('promo_titre').value = currentProduct.promo.titre || '';
            document.getElementById('promo_start').value = currentProduct.promo.start_date || '';
            document.getElementById('promo_end').value = currentProduct.promo.end_date || '';
            document.getElementById('promo_countdown').checked = currentProduct.promo.countdown || false;
            document.getElementById('promo_badge').value = currentProduct.promo.badge || 'PROMO';
        }

        // Preview image
        if (currentProduct.image_url) {
            const preview = document.getElementById('image-preview');
            preview.classList.remove('hidden');
            preview.querySelector('img').src = currentProduct.image_url;
        }
    }

    // Charger finitions par d√©faut
    function loadDefaultFinitions() {
        loadFinitions([
            {nom: 'Standard', desc: 'Inclus', prix: 0},
            {nom: 'Contrecollage', desc: '+8‚Ç¨/m¬≤', prix: 8},
            {nom: 'D√©coupe forme', desc: '+15‚Ç¨', prix: 15}
        ]);
    }

    // Charger finitions
    function loadFinitions(finitions) {
        const container = document.getElementById('finitions-list');
        container.innerHTML = '';
        
        finitions.forEach((fin, index) => {
            container.innerHTML += `
                <div class="flex gap-3 items-center">
                    <input type="text" placeholder="Nom" value="${fin.nom}" 
                           class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg" data-fin="${index}" data-field="nom">
                    <input type="text" placeholder="Description" value="${fin.desc}" 
                           class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg" data-fin="${index}" data-field="desc">
                    <input type="number" placeholder="Prix" value="${fin.prix}" step="0.01"
                           class="w-32 px-4 py-2 border-2 border-gray-300 rounded-lg" data-fin="${index}" data-field="prix">
                    <button type="button" onclick="removeFinition(${index})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg">
                        üóëÔ∏è
                    </button>
                </div>
            `;
        });
    }

    // Ajouter finition
    function addFinition() {
        const container = document.getElementById('finitions-list');
        const index = container.children.length;
        
        const div = document.createElement('div');
        div.className = 'flex gap-3 items-center';
        div.innerHTML = `
            <input type="text" placeholder="Nom" class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg" data-fin="${index}" data-field="nom">
            <input type="text" placeholder="Description" class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg" data-fin="${index}" data-field="desc">
            <input type="number" placeholder="Prix" step="0.01" class="w-32 px-4 py-2 border-2 border-gray-300 rounded-lg" data-fin="${index}" data-field="prix">
            <button type="button" onclick="removeFinition(${index})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg">
                üóëÔ∏è
            </button>
        `;
        container.appendChild(div);
    }

    // Supprimer finition
    function removeFinition(index) {
        const container = document.getElementById('finitions-list');
        container.children[index].remove();
    }

    // Sauvegarder
    document.getElementById('product-form').addEventListener('submit', function(e) {
        e.preventDefault();

        // R√©cup√©rer finitions
        const finitions = [];
        document.querySelectorAll('[data-fin]').forEach(input => {
            const index = parseInt(input.dataset.fin);
            const field = input.dataset.field;
            
            if (!finitions[index]) {
                finitions[index] = {nom: '', desc: '', prix: 0};
            }
            
            finitions[index][field] = field === 'prix' ? parseFloat(input.value) : input.value;
        });

        const product = {
            id: document.getElementById('id').value,
            categorie: document.getElementById('categorie').value,
            nom: document.getElementById('nom').value,
            soustitre: document.getElementById('soustitre').value,
            desc_courte: document.getElementById('desc_courte').value,
            desc_longue: document.getElementById('desc_longue').value,
            image_url: document.getElementById('image_url').value,
            delai: parseInt(document.getElementById('delai').value),
            certification: document.getElementById('certification').value,
            prix_0_10: parseFloat(document.getElementById('prix_0_10').value),
            prix_11_50: parseFloat(document.getElementById('prix_11_50').value),
            prix_51_100: parseFloat(document.getElementById('prix_51_100').value),
            prix_101_300: parseFloat(document.getElementById('prix_101_300').value),
            prix_300_plus: parseFloat(document.getElementById('prix_300_plus').value),
            finitions: finitions.filter(f => f.nom),
            inactive: currentProduct?.inactive || false
        };

        // Promotion
        if (document.getElementById('promo_active').checked) {
            product.promo = {
                prix_promo: parseFloat(document.getElementById('promo_prix').value),
                titre: document.getElementById('promo_titre').value,
                start_date: document.getElementById('promo_start').value,
                end_date: document.getElementById('promo_end').value,
                countdown: document.getElementById('promo_countdown').checked,
                badge: document.getElementById('promo_badge').value
            };
        }

        // Sauvegarder
        let products = JSON.parse(localStorage.getItem('products') || '[]');
        
        if (isNew) {
            products.push(product);
        } else {
            const index = products.findIndex(p => p.id === productId);
            if (index !== -1) {
                products[index] = product;
            }
        }

        localStorage.setItem('products', JSON.stringify(products));
        
        alert('Produit enregistr√© !');
        window.location.href = '/admin-produits.html';
    });

    // Supprimer
    function deleteProduct() {
        if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce produit ?')) return;

        let products = JSON.parse(localStorage.getItem('products') || '[]');
        products = products.filter(p => p.id !== productId);
        localStorage.setItem('products', JSON.stringify(products));

        alert('Produit supprim√© !');
        window.location.href = '/admin-produits.html';
    }

    // Preview image
    document.getElementById('image_url').addEventListener('input', function() {
        const url = this.value;
        const preview = document.getElementById('image-preview');
        
        if (url) {
            preview.classList.remove('hidden');
            preview.querySelector('img').src = url;
        } else {
            preview.classList.add('hidden');
        }
    });

    loadProduct();
    </script>
</body>
</html>
